<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Order Form - Rayaco Ltd</title>
    <meta name="description" content="Create and manage sales orders with our modern, user-friendly interface">
    
    <!-- Load Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <style>
        /* Loading animation styles */
        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 50%, #f0f4ff 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 20px;
            font-size: 18px;
            color: #6b7280;
            font-weight: 500;
        }
        
        /* Hide loading when page is ready */
        .page-loaded .loading-container {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Ensure full height */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        /* CSS override for full width */
        body { 
            margin: 0 !important; 
            padding: 0 !important;
            overflow-x: hidden !important;
        }
        #sales-order-app {
            width: 100vw !important;
            min-height: 100vh !important;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-container" id="loadingScreen">
        <div class="text-center">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading Sales Order Form...</div>
        </div>
    </div>

    <!-- Main Content Container -->
    <div id="sales-order-app"></div>

    <!-- Load jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Load Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script>
        // Get CSRF token from cookie or meta tag
        function getCSRFToken() {
            // Try to get from cookie first
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrf_token') {
                    return value;
                }
            }
            
            // Try to get from meta tag
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            if (metaTag) {
                return metaTag.getAttribute('content');
            }
            
            return '';
        }

        // Simple frappe.call implementation for www pages
        window.frappe = {
            call: function(options) {
                return new Promise((resolve, reject) => {
                    const csrfToken = getCSRFToken();
                    console.log('Making API call to:', options.method, 'with args:', options.args);
                    
                    $.ajax({
                        url: '/api/method/' + options.method,
                        type: 'POST',
                        data: JSON.stringify(options.args || {}),
                        contentType: 'application/json',
                        headers: {
                            'X-Frappe-CSRF-Token': csrfToken,
                            'Accept': 'application/json'
                        },
                        success: function(response) {
                            console.log('API response:', response);
                            if (options.callback) {
                                options.callback(response);
                            }
                            resolve(response);
                        },
                        error: function(xhr, status, error) {
                            console.error('API call failed:', {
                                status: status,
                                error: error,
                                responseText: xhr.responseText,
                                statusCode: xhr.status
                            });
                            reject(new Error(`${error}: ${xhr.responseText}`));
                        }
                    });
                });
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Hide loading screen
            setTimeout(function() {
                document.getElementById('loadingScreen').style.opacity = '0';
                document.body.classList.add('page-loaded');
                setTimeout(function() {
                    document.getElementById('loadingScreen').style.display = 'none';
                }, 500);
            }, 500);
            
            // Initialize Vue app
            if (typeof Vue !== 'undefined') {
                initializeVueApp();
            } else {
                setTimeout(function() {
                    if (typeof Vue !== 'undefined') {
                        initializeVueApp();
                    } else {
                        showError('Vue.js failed to load. Please refresh the page.');
                    }
                }, 1000);
            }
        });
        
        function initializeVueApp() {
            try {
                const { createApp, ref, onMounted, computed } = Vue;

                const app = createApp({
                    setup() {
                        console.log('Vue setup function called');
                        
                        // Form data
                        const salesOrder = ref({
                            customer: '',
                            customer_name: '',
                            transaction_date: new Date().toISOString().split('T')[0],
                            delivery_date: '',
                            currency: 'SAR',
                            selling_price_list: 'Standard Selling',
                            company: '',
                            priority: 'Medium',
                            order_type: 'Sales',
                            // team: '',
                            // showTeamDropdown: false,
                            // showTimeDropdown: false,
                            // customTime: '',
                            // time: ''
                        });

                        const items = ref([]);
                        const loading = ref(false);
                        const saving = ref(false);
                        const sendingEmail = ref(false);
                        const lastCreatedSalesOrder = ref(null);
                        const showSuccessMessage = ref(false);
                        const successMessage = ref('');
                        const isErrorMessage = ref(false);
                        const customers = ref([]);
                        const companies = ref([]);
                        const itemsList = ref([]);
                        const territories = ref([]);
                        const customerGroups = ref([]);
                        const priceLists = ref([]);
                        const cleaningTeams = ref([]);
                        
                        // Dropdown states
                        const showCustomerDropdown = ref(false);
                        const showItemDropdown = ref({});
                        const customerSearchTerm = ref('');
                        const itemSearchTerm = ref({});
                        
                        // Customer creation popup
                        const showCreateCustomerPopup = ref(false);
                        const creatingCustomer = ref(false);
                        const newCustomer = ref({
                            customer_name: '',
                            customer_type: 'Company',
                            customer_group: 'All Customer Groups',
                            territory: 'All Territories',
                            mobile_no: '',
                            email_id: '',
                            address_line1: '',
                            city: '',
                            state: '',
                            country: 'Saudi Arabia',
                            pincode: ''
                        });

                        // Add new item to the items list
                        const addItem = () => {
                            const newIndex = items.value.length;
                            items.value.push({
                                item_code: '',
                                item_name: '',
                                description: '',
                                qty: 1,
                                uom: 'Nos',
                                rate: 0,
                                amount: 0,
                                net_amount: 0
                            });
                            // Initialize dropdown states for new item
                            showItemDropdown.value[newIndex] = false;
                            itemSearchTerm.value[newIndex] = '';
                        };

                        // Remove item from the list
                        const removeItem = (index) => {
                            items.value.splice(index, 1);
                            calculateTotals();
                        };

                        // Calculate item amount
                        const calculateItemAmount = (item) => {
                            const rate = parseFloat(item.rate) || 0;
                            const qty = parseFloat(item.qty) || 0;
                            
                            item.amount = rate * qty;
                            item.net_amount = item.amount;
                            
                            calculateTotals();
                        };

                        // Calculate totals
                        const calculateTotals = () => {
                            const total = items.value.reduce((sum, item) => sum + (parseFloat(item.net_amount) || 0), 0);
                            return total;
                        };

                        // Computed properties
                        const totalAmount = computed(() => calculateTotals());
                        const vatAmount = computed(() => {
                            const total = totalAmount.value || 0;
                            const vat = total * 0.15;
                            return vat;
                        });
                        const grandTotal = computed(() => {
                            const grand = (totalAmount.value || 0) + (vatAmount.value || 0);
                            return grand;
                        });
                        
                        // Filtered customers for search
                        const filteredCustomers = computed(() => {
                            if (!customerSearchTerm.value) return customers.value;
                            return customers.value.filter(customer => 
                                customer.customer_name.toLowerCase().includes(customerSearchTerm.value.toLowerCase()) ||
                                customer.name.toLowerCase().includes(customerSearchTerm.value.toLowerCase())
                            );
                        });
                        
                        // Toggle customer dropdown
                        const toggleCustomerDropdown = () => {
                            showCustomerDropdown.value = !showCustomerDropdown.value;
                        };
                        
                        // Select customer
                        const selectCustomer = async (customer) => {
                            salesOrder.value.customer = customer.name;
                            showCustomerDropdown.value = false;
                            customerSearchTerm.value = '';
                            await onCustomerChange();
                        };
                        
                        // Toggle item dropdown
                        const toggleItemDropdown = (index) => {
                            showItemDropdown.value[index] = !showItemDropdown.value[index];
                        };
                        
                        // Get filtered items for specific row
                        const getFilteredItems = (index) => {
                            const searchTerm = itemSearchTerm.value[index] || '';
                            if (!searchTerm) return itemsList.value;
                            return itemsList.value.filter(item => 
                                item.item_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                item.name.toLowerCase().includes(searchTerm.toLowerCase())
                            );
                        };
                        
                        // Select item
                        const selectItem = async (item, index) => {
                            items.value[index].item_code = item.name;
                            showItemDropdown.value[index] = false;
                            itemSearchTerm.value[index] = '';
                            await onItemChange(items.value[index]);
                        };
                        
                        // Helper function to show messages
                        const showMessage = (message, isError = false) => {
                            successMessage.value = message;
                            isErrorMessage.value = isError;
                            showSuccessMessage.value = true;
                            setTimeout(() => { showSuccessMessage.value = false; }, 5000);
                        };

                        // Customer creation functions
                        const openCreateCustomerPopup = () => {
                            showCreateCustomerPopup.value = true;
                            showCustomerDropdown.value = false;
                        };
                        
                        const closeCreateCustomerPopup = () => {
                            showCreateCustomerPopup.value = false;
                            resetNewCustomerForm();
                        };
                        
                        const resetNewCustomerForm = () => {
                            newCustomer.value = {
                                customer_name: '',
                                customer_type: 'Company',
                                customer_group: 'All Customer Groups',
                                territory: 'All Territories',
                                mobile_no: '',
                                email_id: '',
                                address_line1: '',
                                city: '',
                                state: '',
                                country: 'Saudi Arabia',
                                pincode: ''
                            };
                        };
                        
                        const createNewCustomer = async () => {
                            try {
                                creatingCustomer.value = true;
                                
                                if (!newCustomer.value.customer_name) {
                                    showMessage('Customer name is required', true);
                                    return;
                                }
                                
                                console.log('Creating new customer:', newCustomer.value);
                                
                                const response = await frappe.call({
                                    method: "services_ordering.www.sales_order_form.create_customer",
                                    args: {
                                        customer_data: newCustomer.value
                                    }
                                });
                                
                                if (response && response.message && response.message.success) {
                                    lastCreatedSalesOrder.value = response.message;
                                    
                                    // Show custom success message
                                    let successDetails = `Sales Order ${response.message.sales_order_name} created successfully!`;
                                    if (response.message.data?.custom_time) {
                                        successDetails += ` Time: ${response.message.data.custom_time}`;
                                    }
                                    if (response.message.data?.custom_team) {
                                        const teamName = cleaningTeams.value.find(t => t.name === response.message.data.custom_team)?.name1 || response.message.data.custom_team;
                                        successDetails += ` Team: ${teamName}`;
                                    }
                                    
                                    // Show custom success message
                                    successMessage.value = successDetails;
                                    isErrorMessage.value = false;
                                    showSuccessMessage.value = true;
                                    
                                    // Auto-hide success message after 5 seconds
                                    setTimeout(() => {
                                        showSuccessMessage.value = false;
                                    }, 5000);
                                    
                                    // Don't reset form - let user decide when to reset
                                } else {
                                    successMessage.value = 'Error creating customer: ' + (response?.message?.message || 'Unknown error');
                                    isErrorMessage.value = true;
                                    showSuccessMessage.value = true;
                                    setTimeout(() => { showSuccessMessage.value = false; }, 5000);
                                }
                                
                            } catch (error) {
                                console.error('Error creating customer:', error);
                                successMessage.value = 'Error creating customer: ' + error.message;
                                isErrorMessage.value = true;
                                showSuccessMessage.value = true;
                                setTimeout(() => { showSuccessMessage.value = false; }, 5000);
                            } finally {
                                creatingCustomer.value = false;
                            }
                        };

                        // Test backend connection
                        const testBackendConnection = async () => {
                            try {
                                console.log('Testing backend connection...');
                                console.log('Calling method: services_ordering.sales_order_form.test_connection');
                                
                                const testResponse = await frappe.call({
                                    method: "services_ordering.www.sales_order_form.test_connection"
                                });
                                
                                console.log('Backend test response:', testResponse);
                                console.log('Response structure:', {
                                    hasMessage: !!testResponse.message,
                                    messageType: typeof testResponse.message,
                                    messageContent: testResponse.message
                                });
                                
                                // Check different possible response structures
                                if (testResponse && testResponse.message) {
                                    if (typeof testResponse.message === 'object' && testResponse.message.success) {
                                        return true;
                                    } else if (typeof testResponse.message === 'string') {
                                        // Sometimes Frappe returns the result as a JSON string
                                        try {
                                            const parsed = JSON.parse(testResponse.message);
                                            return parsed && parsed.success;
                                        } catch (e) {
                                            console.log('Message is not JSON:', testResponse.message);
                                            return false;
                                        }
                                    }
                                }
                                
                                return false;
                            } catch (error) {
                                console.error('Backend connection test failed:', error);
                                console.error('Error details:', {
                                    name: error.name,
                                    message: error.message,
                                    stack: error.stack
                                });
                                return false;
                            }
                        };

                        // Fetch master data from backend
                        const fetchMasterData = async () => {
                            try {
                                loading.value = true;
                                console.log('Fetching master data from backend...');
                                
                                // Test backend connection first
                                console.log('Testing backend connection...');
                                const connectionTest = await testBackendConnection();
                                if (!connectionTest) {
                                    throw new Error('Backend connection test failed');
                                }
                                
                                const response = await frappe.call({
                                    method: "services_ordering.www.sales_order_form.get_master_data",
                                    callback: function(r) {
                                        console.log('Frappe call response:', r);
                                    }
                                });

                                console.log('Raw response:', response);

                                if (response && response.message && response.message.success) {
                                    const data = response.message.data;
                                    customers.value = data.customers || [];
                                    companies.value = data.companies || [];
                                    itemsList.value = data.items || [];
                                    territories.value = data.territories || [];
                                    customerGroups.value = data.customer_groups || [];
                                    priceLists.value = data.price_lists || [];
                                    cleaningTeams.value = data.cleaning_teams || [];
                                    
                                    console.log('Master data loaded successfully:', {
                                        customers: customers.value.length,
                                        companies: companies.value.length,
                                        items: itemsList.value.length,
                                        // warehouses removed
                                    });
                                } else {
                                    console.error('Failed to fetch master data:', response);
                                    successMessage.value = 'Failed to load master data: ' + (response?.message?.message || 'Unknown error');
                                    isErrorMessage.value = true;
                                    showSuccessMessage.value = true;
                                    setTimeout(() => { showSuccessMessage.value = false; }, 5000);
                                }
                            } catch (error) {
                                console.error('Error fetching master data:', error);
                                successMessage.value = 'Error loading data: ' + error.message;
                                isErrorMessage.value = true;
                                showSuccessMessage.value = true;
                                setTimeout(() => { showSuccessMessage.value = false; }, 5000);
                            } finally {
                                loading.value = false;
                            }
                        };

                        // Save Sales Order
                        const saveSalesOrder = async () => {
                            try {
                                saving.value = true;
                                
                                if (!salesOrder.value.customer) {
                                    showMessage('Please select a customer', true);
                                    return;
                                }
                                
                                if (items.value.length === 0) {
                                    showMessage('Please add at least one item', true);
                                    return;
                                }

                                // Prepare sales order data
                                const salesOrderData = {
                                    ...salesOrder.value,
                                    items: items.value,
                                    // time: formatTimeTo24Hour(salesOrder.value.time), // Ensure 24h format
                                    // team: salesOrder.value.team
                                };

                                console.log('Creating sales order:', salesOrderData);

                                const response = await frappe.call({
                                    method: "services_ordering.www.sales_order_form.create_sales_order",
                                    args: {
                                        sales_order_data: salesOrderData
                                    }
                                });

                                if (response.message && response.message.success) {
                                    lastCreatedSalesOrder.value = response.message;
                                    
                                    // Show custom success message
                                    let successDetails = `Sales Order ${response.message.sales_order_name} created successfully!`;
                                    if (response.message.data?.custom_time) {
                                        successDetails += ` Time: ${response.message.data.custom_time}`;
                                    }
                                    if (response.message.data?.custom_team) {
                                        const teamName = cleaningTeams.value.find(t => t.name === response.message.data.custom_team)?.name1 || response.message.data.custom_team;
                                        successDetails += ` Team: ${teamName}`;
                                    }
                                    successMessage.value = successDetails;
                                    isErrorMessage.value = false;
                                    showSuccessMessage.value = true;
                                    
                                    // Auto-hide success message after 5 seconds
                                    setTimeout(() => {
                                        showSuccessMessage.value = false;
                                    }, 5000);
                                    
                                    // Don't reset form - let user decide when to reset
                                } else {
                                    // Show custom error message
                                    successMessage.value = 'Error creating sales order: ' + (response.message?.message || 'Unknown error');
                                    isErrorMessage.value = true;
                                    showSuccessMessage.value = true;
                                    
                                    // Auto-hide error message after 5 seconds
                                    setTimeout(() => {
                                        showSuccessMessage.value = false;
                                    }, 5000);
                                }

                            } catch (error) {
                                console.error('Error saving sales order:', error);
                                
                                // Show custom error message
                                successMessage.value = 'Error creating sales order: ' + error.message;
                                isErrorMessage.value = true;
                                showSuccessMessage.value = true;
                                
                                // Auto-hide error message after 5 seconds
                                setTimeout(() => {
                                    showSuccessMessage.value = false;
                                }, 5000);
                            } finally {
                                saving.value = false;
                            }
                        };

                        // Reset form
                        const resetForm = () => {
                            if (!confirm('Are you sure you want to reset the form? All unsaved data will be lost.')) {
                                return; // If user clicks Cancel, do nothing
                            }
                            
                            salesOrder.value = {
                                customer: '',
                                customer_name: '',
                                transaction_date: new Date().toISOString().split('T')[0],
                                delivery_date: '',
                                currency: 'SAR',
                                selling_price_list: 'Standard Selling',
                                company: '',
                                priority: 'Medium',
                                order_type: 'Sales',
                                // team: '',
                                // showTeamDropdown: false,
                                // showTimeDropdown: false,
                                // customTime: '',
                                // time: ''
                            };
                            items.value = [];
                            lastCreatedSalesOrder.value = null;
                            showSuccessMessage.value = false;
                        };

                        // Send Email with PDF
                        const sendEmail = async () => {
                            try {
                                sendingEmail.value = true;
                                
                                if (!lastCreatedSalesOrder.value) {
                                    successMessage.value = 'No Sales Order to send. Please create a Sales Order first.';
                                    showSuccessMessage.value = true;
                                    setTimeout(() => { showSuccessMessage.value = false; }, 5000);
                                    return;
                                }

                                if (!salesOrder.value.customer) {
                                    successMessage.value = 'Customer information is missing.';
                                    showSuccessMessage.value = true;
                                    setTimeout(() => { showSuccessMessage.value = false; }, 5000);
                                    return;
                                }

                                // Send email with PDF attachment using our improved method
                                const emailResponse = await frappe.call({
                                    method: "services_ordering.www.sales_order_form.send_sales_order_email",
                                    args: {
                                        sales_order_name: lastCreatedSalesOrder.value.sales_order_name,
                                        customer_name: salesOrder.value.customer
                                    }
                                });

                                if (emailResponse.message && emailResponse.message.success) {
                                    successMessage.value = emailResponse.message.message;
                                    showSuccessMessage.value = true;
                                    setTimeout(() => { showSuccessMessage.value = false; }, 5000);
                                } else {
                                    successMessage.value = 'Error sending email: ' + (emailResponse.message?.message || 'Unknown error');
                                    showSuccessMessage.value = true;
                                    setTimeout(() => { showSuccessMessage.value = false; }, 5000);
                                }

                            } catch (error) {
                                console.error('Error sending email:', error);
                                successMessage.value = 'Error sending email: ' + error.message;
                                showSuccessMessage.value = true;
                                setTimeout(() => { showSuccessMessage.value = false; }, 5000);
                            } finally {
                                sendingEmail.value = false;
                            }
                        };

                        // Handle customer selection
                        const onCustomerChange = async () => {
                            const selectedCustomer = customers.value.find(c => c.name === salesOrder.value.customer);
                            if (selectedCustomer) {
                                salesOrder.value.customer_name = selectedCustomer.customer_name;
                                salesOrder.value.customer_group = selectedCustomer.customer_group;
                                salesOrder.value.territory = selectedCustomer.territory;
                                
                                // Fetch detailed customer info from backend
                                try {
                                    const response = await frappe.call({
                                        method: "services_ordering.www.sales_order_form.get_customer_details",
                                        args: {
                                            customer: salesOrder.value.customer
                                        }
                                    });
                                    
                                    if (response.message && response.message.success) {
                                        const customerDetails = response.message.data;
                                        salesOrder.value.currency = customerDetails.default_currency || salesOrder.value.currency;
                                        salesOrder.value.selling_price_list = customerDetails.default_price_list || salesOrder.value.selling_price_list;
                                        salesOrder.value.payment_terms_template = customerDetails.payment_terms;
                                        
                                        // Set address and contact if available
                                        if (customerDetails.default_address) {
                                            salesOrder.value.customer_address = customerDetails.default_address.name;
                                        }
                                        if (customerDetails.default_contact) {
                                            salesOrder.value.contact_person = customerDetails.default_contact.name;
                                            salesOrder.value.contact_display = `${customerDetails.default_contact.first_name} ${customerDetails.default_contact.last_name}`;
                                            salesOrder.value.contact_mobile = customerDetails.default_contact.mobile_no;
                                            salesOrder.value.contact_email = customerDetails.default_contact.email_id;
                                        }
                                    }
                                } catch (error) {
                                    console.error('Error fetching customer details:', error);
                                }
                            }
                        };

                        // Handle item selection
                        const onItemChange = async (item) => {
                            const selectedItem = itemsList.value.find(i => i.name === item.item_code);
                            if (selectedItem) {
                                item.item_name = selectedItem.item_name;
                                item.description = selectedItem.description;
                                item.uom = selectedItem.stock_uom;
                                item.rate = selectedItem.standard_rate || 0;
                                calculateItemAmount(item);
                                
                                // Optionally fetch detailed item info from backend
                                try {
                                    const response = await frappe.call({
                                        method: "services_ordering.www.sales_order_form.get_item_details",
                                        args: {
                                            item_code: item.item_code,
                                            customer: salesOrder.value.customer,
                                            company: salesOrder.value.company,
                                            price_list: salesOrder.value.selling_price_list
                                        }
                                    });
                                    
                                    if (response.message && response.message.success) {
                                        const itemDetails = response.message.data;
                                        item.rate = itemDetails.rate || item.rate;
                                        item.item_tax_template = itemDetails.item_tax_template;
                                        calculateItemAmount(item);
                                    }
                                } catch (error) {
                                    console.error('Error fetching item details:', error);
                                }
                            }
                        };

                        // Format time to ensure 24-hour format (temporarily disabled)
                        /* 
                        const formatTimeTo24Hour = (timeStr) => {
                            if (!timeStr) return '';
                            
                            // If the time already uses 24-hour format, return as is
                            if (/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(timeStr)) {
                                return timeStr;
                            }
                            
                            // Try to convert from 12-hour format if needed
                            try {
                                const timeParts = timeStr.match(/(\d+):(\d+)\s*([AP]M)?/i);
                                if (timeParts) {
                                    let hours = parseInt(timeParts[1]);
                                    const minutes = timeParts[2];
                                    const period = timeParts[3]?.toUpperCase();
                                    
                                    if (period === 'PM' && hours < 12) {
                                        hours += 12;
                                    } else if (period === 'AM' && hours === 12) {
                                        hours = 0;
                                    }
                                    
                                    return `${hours.toString().padStart(2, '0')}:${minutes}`;
                                }
                            } catch (e) {
                                console.error('Error parsing time:', e);
                            }
                            
                            // Return original if parsing failed
                            return timeStr;
                        };
                        */
                        const formatTimeTo24Hour = () => { return ''; }; // Placeholder function

                        onMounted(() => {
                            console.log('Vue onMounted called');
                            fetchMasterData();
                            addItem(); // Add first item by default
                            
                            // Add beforeunload event to show confirmation before page refresh
                            window.addEventListener('beforeunload', (event) => {
                                // Check if there's any data in the form that would be lost
                                if (salesOrder.value.customer || items.value.length > 1 || 
                                    items.value[0]?.item_code || salesOrder.value.time || salesOrder.value.team) {
                                    // Cancel the event
                                    event.preventDefault();
                                    // Chrome requires returnValue to be set
                                    event.returnValue = 'Are you sure you want to leave? Your unsaved changes will be lost.';
                                    return event.returnValue;
                                }
                            }); 
                        });

                        return {
                            salesOrder,
                            items,
                            loading,
                            saving,
                            sendingEmail,
                            lastCreatedSalesOrder,
                            showSuccessMessage,
                            successMessage,
                            isErrorMessage,
                            customers,
                            companies,
                            territories,
                            customerGroups,
                            itemsList,
                            cleaningTeams,
                            totalAmount,
                            vatAmount,
                            grandTotal,
                            addItem,
                            removeItem,
                            calculateItemAmount,
                            saveSalesOrder,
                            resetForm,
                            sendEmail,
                            onCustomerChange,
                            onItemChange,
                            showMessage,
                            // Dropdowns and search
                            showCustomerDropdown,
                            showItemDropdown,
                            customerSearchTerm,
                            itemSearchTerm,
                            filteredCustomers,
                            toggleCustomerDropdown,
                            selectCustomer,
                            toggleItemDropdown,
                            getFilteredItems,
                            selectItem,
                            // Customer creation modal
                            showCreateCustomerPopup,
                            creatingCustomer,
                            newCustomer,
                            openCreateCustomerPopup,
                            closeCreateCustomerPopup,
                            createNewCustomer,
                            // Time formatting - temporarily disabled
                            // formatTimeTo24Hour
                        };
                    },

                    template: `
                        <div class="min-h-screen bg-gradient-to-br from-green-100 via-white to-yellow-100 p-4">
                            <!-- Success/Error Message Popup -->
                            <div v-if="showSuccessMessage" class="fixed top-4 right-4 z-50 max-w-md">
                                <div :class="isErrorMessage ? 'bg-white border-l-4 border-red-500 rounded-lg shadow-lg p-4 flex items-center' : 'bg-white border-l-4 border-green-500 rounded-lg shadow-lg p-4 flex items-center'">
                                    <div class="flex-shrink-0">
                                        <!-- Success Icon -->
                                        <svg v-if="!isErrorMessage" class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <!-- Error Icon -->
                                        <svg v-else class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-3 flex-1">
                                        <p class="text-sm font-medium text-gray-900">{{ successMessage }}</p>
                                    </div>
                                    <div class="ml-4 flex-shrink-0">
                                        <button @click="showSuccessMessage = false" class="text-gray-400 hover:text-gray-600">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Header Section -->
                            <div class="max-w-7xl mx-auto">
                                <div class="text-center mb-8">
                                    <h1 class="text-4xl font-bold text-gray-800 mb-2" style="font-family: 'Cairo', sans-serif;">Create Order</h1>
                                </div>

                                <!-- Main Form -->
                                <div class="space-y-8">
                                    <!-- Customer Information Card -->
                                    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-6">
                                        <div class="flex items-center mb-6">
                                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                <svg class="w-6 h-6 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                </svg>
                                            </div>
                                            <div>
                                                <h2 class="text-2xl font-semibold text-gray-800">Customer Information</h2>
                                                <p class="text-sm text-gray-600">Select customer and basic order details</p>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Customer *</label>
                                                <div class="relative">
                                                    <!-- Enhanced Customer Dropdown -->
                                                    <div 
                                                        @click="toggleCustomerDropdown"
                                                        class="border-2 border-gray-200 rounded-xl p-4 bg-white cursor-pointer hover:border-green-400 hover:shadow-md transition-all duration-200 flex justify-between items-center"
                                                    >
                                                        <div class="flex items-center">
                                                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                                                <svg class="w-5 h-5 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                                </svg>
                                                            </div>
                                                            <span class="text-gray-700 font-medium">
                                                                \{\{ salesOrder.customer ? (customers.find(c => c.name === salesOrder.customer)?.customer_name || salesOrder.customer) : 'Select customer...' \}\}
                                                            </span>
                                                        </div>
                                                        <svg class="w-6 h-6 text-gray-400 transition-transform duration-200" :class="showCustomerDropdown ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                        </svg>
                                                    </div>
                                                    
                                                    <!-- Enhanced Dropdown Options -->
                                                    <div v-if="showCustomerDropdown" class="absolute z-20 w-full mt-2 bg-white border-2 border-gray-200 rounded-xl shadow-2xl max-h-80 overflow-y-auto">
                                                        <div class="p-4">
                                                            <!-- Enhanced Search Box -->
                                                            <div class="relative mb-4">
                                                                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                                                </svg>
                                                                <input 
                                                                    v-model="customerSearchTerm"
                                                                    type="text"
                                                                    placeholder="Search customers..."
                                                                    class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-600 focus:border-green-600 transition-all duration-200"
                                                                >
                                                            </div>
                                                            
                                                            <!-- Enhanced Options List -->
                                                            <div class="space-y-2">
                                                                <div 
                                                                    v-for="customer in filteredCustomers" 
                                                                    :key="customer.name"
                                                                    @click="selectCustomer(customer)"
                                                                    class="flex items-center p-3 hover:bg-green-50 rounded-lg cursor-pointer transition-colors duration-200 border border-transparent hover:border-green-200"
                                                                >
                                                                    <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                                        </svg>
                                                                    </div>
                                                                    <div class="flex-1">
                                                                        <div class="font-semibold text-gray-900 text-base">\{\{ customer.customer_name \}\}</div>
                                                                        <div class="text-sm text-gray-600 mt-1">
                                                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 mr-2">
                                                                                🏢 \{\{ customer.name \}\}
                                                                            </span>
                                                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                                                📍 \{\{ customer.territory || 'N/A' \}\}
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Enhanced No Results Message -->
                                                            <div v-if="filteredCustomers.length === 0" class="text-center py-8 text-gray-500">
                                                                <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                                </svg>
                                                                <p class="text-lg font-medium">No customers found</p>
                                                                <p class="text-sm">Try adjusting your search terms</p>
                                                            </div>
                                                            
                                                            <!-- Create New Customer Button -->
                                                            <div class="border-t border-gray-200 pt-4 mt-4">
                                                                <button 
                                                                    @click="openCreateCustomerPopup"
                                                                    class="w-full px-4 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center justify-center font-semibold"
                                                                >
                                                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                                    </svg>
                                                                    Create New Customer
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Company</label>
                                                <div class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl bg-gray-50 text-gray-700 font-medium">
                                                    Sage Services Co Ltd.
                                                </div>
                                            </div>

                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Transaction Date *</label>
                                                <input 
                                                    type="date"
                                                    v-model="salesOrder.transaction_date"
                                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                                    required
                                                >
                                            </div>

                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Date</label>
                                                <input 
                                                    type="date"
                                                    v-model="salesOrder.delivery_date"
                                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                                >
                                            </div>

                                            <!-- Time dropdown temporarily disabled
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                                                <div class="relative">
                                                    <div 
                                                        class="border-2 border-gray-200 rounded-xl p-4 bg-gray-100 text-gray-500 flex items-center"
                                                    >
                                                        <div class="flex items-center">
                                                            <div class="w-8 h-8 bg-gray-200 rounded-lg flex items-center justify-center mr-3">
                                                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                                </svg>
                                                            </div>
                                                            <span class="text-gray-500 font-medium">
                                                                Time feature temporarily disabled
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            -->

                                            <!-- Team dropdown temporarily disabled
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Team</label>
                                                <div class="relative">
                                                    <div class="border-2 border-gray-200 rounded-xl p-4 bg-gray-100 text-gray-500 flex items-center">
                                                        <div class="flex items-center">
                                                            <div class="w-8 h-8 bg-gray-200 rounded-lg flex items-center justify-center mr-3">
                                                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                                                </svg>
                                                            </div>
                                                            <span class="text-gray-500 font-medium">
                                                                Team feature temporarily disabled
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            -->
                                        </div>
                                    </div>

                                                                    <!-- Items Section -->
                                <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-6" style="overflow: visible; position: relative; z-index: 10;">
                                        <div class="flex items-center justify-between mb-6">
                                            <div class="flex items-center">
                                                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <h2 class="text-2xl font-semibold text-gray-800">Items</h2>
                                                    <p class="text-sm text-gray-600">Add items to your sales order</p>
                                                </div>
                                            </div>
                                            <button 
                                                @click="addItem"
                                                class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl hover:from-green-600 hover:to-green-700 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center"
                                            >
                                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                </svg>
                                                Add Item
                                            </button>
                                        </div>

                                        <!-- Items Table -->
                                        <div class="overflow-x-auto" style="overflow: visible;">
                                            <table class="w-full table-fixed">
                                                <thead>
                                                    <tr class="bg-gradient-to-r from-green-50 to-yellow-50 border-b-2 border-gray-200">
                                                        <th class="w-96 px-4 py-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Item</th>
                                                        <th class="w-28 px-4 py-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Qty</th>
                                                        <th class="w-40 px-4 py-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Rate</th>
                                                        <th class="w-40 px-4 py-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Amount</th>
                                                        <th class="w-20 px-4 py-4 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white divide-y divide-gray-200">
                                                    <tr v-for="(item, index) in items" :key="index" class="hover:bg-gray-50 transition-colors duration-200">
                                                        <td class="px-4 py-4 w-96">
                                                            <div class="relative">
                                                                <!-- Enhanced Item Dropdown -->
                                                                <div 
                                                                    @click="toggleItemDropdown(index)"
                                                                    class="border-2 border-gray-200 rounded-lg p-2 bg-white cursor-pointer hover:border-blue-300 hover:shadow-md transition-all duration-200 flex justify-between items-center w-full"
                                                                >
                                                                    <div class="flex items-center flex-1 min-w-0">
                                                                        <div class="w-5 h-5 bg-purple-100 rounded flex items-center justify-center mr-2 flex-shrink-0">
                                                                            <svg class="w-3 h-3 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                                                            </svg>
                                                                        </div>
                                                                        <span class="text-gray-700 font-medium text-xs truncate">
                                                                            \{\{ item.item_code ? (itemsList.find(i => i.name === item.item_code)?.item_name || item.item_code) : 'Select item...' \}\}
                                                                        </span>
                                                                    </div>
                                                                    <svg class="w-4 h-4 text-gray-400 transition-transform duration-200 flex-shrink-0 ml-1" :class="showItemDropdown[index] ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                                    </svg>
                                                                </div>
                                                                
                                                                <!-- Enhanced Dropdown Options -->
                                                                <div v-if="showItemDropdown[index]" class="absolute z-50 left-0 mt-2 bg-white border-2 border-gray-200 rounded-xl shadow-2xl max-h-80 overflow-y-auto w-96" style="min-width: 400px;">
                                                                    <div class="p-4">
                                                                        <!-- Enhanced Search Box -->
                                                                        <div class="relative mb-4">
                                                                            <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                                                            </svg>
                                                                            <input 
                                                                                v-model="itemSearchTerm[index]"
                                                                                type="text"
                                                                                placeholder="Search items..."
                                                                                class="w-full pl-10 pr-4 py-2 border-2 border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                                                            >
                                                                        </div>
                                                                        
                                                                        <!-- Enhanced Options List -->
                                                                        <div class="space-y-2 max-h-60 overflow-y-auto">
                                                                            <div 
                                                                                v-for="itemOption in getFilteredItems(index)" 
                                                                                :key="itemOption.name"
                                                                                @click="selectItem(itemOption, index)"
                                                                                class="flex items-center p-3 hover:bg-purple-50 rounded-lg cursor-pointer transition-colors duration-200 border border-transparent hover:border-purple-200"
                                                                            >
                                                                                <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                                                                    <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                                                                    </svg>
                                                                                </div>
                                                                                <div class="flex-1 min-w-0">
                                                                                    <div class="font-semibold text-gray-900 text-sm truncate">\{\{ itemOption.item_name \}\}</div>
                                                                                    <div class="text-xs text-gray-600 mt-1">
                                                                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 mr-2">
                                                                                            🏷️ \{\{ itemOption.name \}\}
                                                                                        </span>
                                                                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                                                            💰 \{\{ (itemOption.standard_rate || 0).toLocaleString('en-US', { style: 'currency', currency: 'SAR' }) \}\}
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        
                                                                        <!-- Enhanced No Results Message -->
                                                                        <div v-if="getFilteredItems(index).length === 0" class="text-center py-6 text-gray-500">
                                                                            <svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                                                            </svg>
                                                                            <p class="text-sm font-medium">No items found</p>
                                                                            <p class="text-xs">Try adjusting your search terms</p>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td class="px-4 py-4 w-28">
                                                            <input 
                                                                type="number"
                                                                v-model="item.qty"
                                                                @input="calculateItemAmount(item)"
                                                                min="1"
                                                                step="1"
                                                                class="w-full px-2 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm"
                                                            >
                                                        </td>
                                                        <td class="px-4 py-4 w-40">
                                                            <input 
                                                                type="number"
                                                                v-model="item.rate"
                                                                @input="calculateItemAmount(item)"
                                                                min="0"
                                                                step="0.01"
                                                                class="w-full px-2 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm"
                                                            >
                                                        </td>
                                                        <td class="px-4 py-4 w-40">
                                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 w-full justify-center">
                                                                \{\{ (item.net_amount || 0).toLocaleString('en-US', { style: 'currency', currency: 'SAR' }) \}\}
                                                            </span>
                                                        </td>
                                                        <td class="px-4 py-4 text-center w-20">
                                                            <button 
                                                                @click="removeItem(index)"
                                                                class="text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded-lg transition-all duration-200"
                                                                title="Remove Item"
                                                            >
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                </svg>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>

                                        <!-- Totals Section -->
                                        <div class="mt-6 flex justify-end">
                                            <div class="bg-gradient-to-r from-green-50 to-yellow-50 rounded-xl p-6 border border-green-200">
                                                <div class="space-y-3">
                                                    <div class="flex justify-between items-center">
                                                        <span class="text-lg font-medium text-gray-700">Total Amount:</span>
                                                        <span class="text-xl font-bold text-green-700">
                                                            \{\{ (totalAmount || 0).toLocaleString('en-US', { style: 'currency', currency: 'SAR' }) \}\}
                                                        </span>
                                                    </div>
                                                    <div class="flex justify-between items-center">
                                                        <span class="text-lg font-medium text-gray-700">VAT (15%):</span>
                                                        <span class="text-xl font-bold text-blue-700">
                                                            \{\{ (vatAmount || 0).toLocaleString('en-US', { style: 'currency', currency: 'SAR' }) \}\}
                                                        </span>
                                                    </div>
                                                    <div class="flex justify-between items-center border-t border-green-200 pt-3">
                                                        <span class="text-xl font-semibold text-gray-800">Grand Total:</span>
                                                        <span class="text-2xl font-bold text-green-600">
                                                            \{\{ (grandTotal || 0).toLocaleString('en-US', { style: 'currency', currency: 'SAR' }) \}\}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="flex justify-center space-x-4">
                                        <button 
                                            @click="resetForm"
                                            class="px-8 py-4 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-xl hover:from-gray-600 hover:to-gray-700 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center font-semibold text-lg"
                                        >
                                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                            </svg>
                                            Reset Form
                                        </button>
                                        
                                        <!-- Send Email Button - Only show after successful Sales Order creation -->
                                        <button 
                                            v-if="lastCreatedSalesOrder"
                                            @click="sendEmail"
                                            :disabled="sendingEmail"
                                            class="px-8 py-4 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl hover:from-green-600 hover:to-green-700 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none flex items-center font-semibold text-lg"
                                        >
                                            <svg v-if="!sendingEmail" class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 002 2v10a2 2 0 002 2z"></path>
                                            </svg>
                                            <div v-else class="w-6 h-6 mr-2 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            \{\{ sendingEmail ? 'Sending Email...' : 'Send Email' \}\}
                                        </button>
                                        
                                        <button 
                                            @click="saveSalesOrder"
                                            :disabled="saving"
                                            class="px-8 py-4 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl hover:from-green-700 hover:to-green-800 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none flex items-center font-semibold text-lg"
                                        >
                                            <svg v-if="!saving" class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <div v-else class="w-6 h-6 mr-2 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            \{\{ saving ? 'Creating Sales Order...' : 'Create Order' \}\}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Create Customer Popup Modal -->
                        <div v-if="showCreateCustomerPopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                                <div class="p-6">
                                    <!-- Modal Header -->
                                    <div class="flex items-center justify-between mb-6">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                </svg>
                                            </div>
                                            <h2 class="text-2xl font-bold text-gray-800">Create New Customer</h2>
                                        </div>
                                        <button @click="closeCreateCustomerPopup" class="text-gray-400 hover:text-gray-600 transition-colors">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    
                                    <!-- Customer Form -->
                                    <div class="space-y-6">
                                        <!-- Basic Information -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Customer Name *</label>
                                                <input 
                                                    v-model="newCustomer.customer_name"
                                                    type="text"
                                                    placeholder="Enter customer name"
                                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                                                    required
                                                >
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Customer Type</label>
                                                <select 
                                                    v-model="newCustomer.customer_type"
                                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                                                >
                                                    <option value="Company">Company</option>
                                                    <option value="Individual">Individual</option>
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Customer Group</label>
                                                <select 
                                                    v-model="newCustomer.customer_group"
                                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                                                >
                                                    <option value="All Customer Groups">All Customer Groups</option>
                                                    <option v-for="group in customerGroups" :key="group.name" :value="group.name">
                                                        \{\{ group.name \}\}
                                                    </option>
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Territory</label>
                                                <select 
                                                    v-model="newCustomer.territory"
                                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                                                >
                                                    <option value="All Territories">All Territories</option>
                                                    <option v-for="territory in territories" :key="territory.name" :value="territory.name">
                                                        \{\{ territory.name \}\}
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <!-- Contact Information -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Mobile Number</label>
                                                <input 
                                                    v-model="newCustomer.mobile_no"
                                                    type="tel"
                                                    placeholder="Enter mobile number"
                                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                                                >
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                                                <input 
                                                    v-model="newCustomer.email_id"
                                                    type="email"
                                                    placeholder="Enter email address"
                                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                                                >
                                            </div>
                                        </div>
                                        
                                        <!-- Address Information -->
                                        <div class="space-y-4">
                                            <h3 class="text-lg font-semibold text-gray-800">Address Information</h3>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Address Line 1</label>
                                                <input 
                                                    v-model="newCustomer.address_line1"
                                                    type="text"
                                                    placeholder="Enter address"
                                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                                                >
                                            </div>
                                            
                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                                                    <input 
                                                        v-model="newCustomer.city"
                                                        type="text"
                                                        placeholder="Enter city"
                                                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                                                    >
                                                </div>
                                                
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                                                    <input 
                                                        v-model="newCustomer.state"
                                                        type="text"
                                                        placeholder="Enter state"
                                                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                                                    >
                                                </div>
                                                
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">PIN Code</label>
                                                    <input 
                                                        v-model="newCustomer.pincode"
                                                        type="text"
                                                        placeholder="Enter PIN code"
                                                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                                                    >
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                                                <input 
                                                    v-model="newCustomer.country"
                                                    type="text"
                                                    placeholder="Enter country"
                                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                                                >
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Modal Footer -->
                                    <div class="flex justify-end space-x-4 mt-8 pt-6 border-t border-gray-200">
                                        <button 
                                            @click="closeCreateCustomerPopup"
                                            class="px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all duration-200 font-semibold"
                                        >
                                            Cancel
                                        </button>
                                        <button 
                                            @click="createNewCustomer"
                                            :disabled="creatingCustomer || !newCustomer.customer_name"
                                            class="px-8 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl hover:from-green-600 hover:to-green-700 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none flex items-center font-semibold"
                                        >
                                            <svg v-if="!creatingCustomer" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            <div v-else class="w-5 h-5 mr-2 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            \{\{ creatingCustomer ? 'Creating Customer...' : 'Create Customer' \}\}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                });

                app.mount("#sales-order-app");
                console.log('Vue app mounted successfully');
            } catch (error) {
                console.error('Error creating Vue app:', error);
                showError('Error initializing the page: ' + error.message);
            }
        }
        
        function showError(message) {
            document.getElementById('loadingScreen').innerHTML = `
                <div class="text-center">
                    <div style="color: #ef4444; font-size: 24px; margin-bottom: 16px;">⚠️</div>
                    <div style="color: #ef4444; font-size: 18px; font-weight: 500;">Error Loading Page</div>
                    <div style="color: #6b7280; font-size: 14px; margin-top: 8px;">${message}</div>
                    <button onclick="window.location.reload()" style="margin-top: 16px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        Refresh Page
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html>